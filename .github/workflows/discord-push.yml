name: Notify Discord with Style

on: [push]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Prepare and send Discord notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          REPO: ${{ github.repository }}
          USER: ${{ github.actor }}
        run: |
          COMMIT_MSG=$(jq -r '.head_commit.message' "$GITHUB_EVENT_PATH")
          URL=$(jq -r '.head_commit.url' "$GITHUB_EVENT_PATH")

          ADDED=$(jq -r '.head_commit.added | if length == 0 then "âŒ None" else join("\n") end' "$GITHUB_EVENT_PATH")
          MODIFIED=$(jq -r '.head_commit.modified | if length == 0 then "âŒ None" else join("\n") end' "$GITHUB_EVENT_PATH")
          REMOVED=$(jq -r '.head_commit.removed | if length == 0 then "âŒ None" else join("\n") end' "$GITHUB_EVENT_PATH")

          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          PAYLOAD=$(jq -n --arg repo "$REPO" \
                          --arg user "$USER" \
                          --arg msg "$COMMIT_MSG" \
                          --arg url "$URL" \
                          --arg added "$ADDED" \
                          --arg modified "$MODIFIED" \
                          --arg removed "$REMOVED" \
                          --arg timestamp "$TIMESTAMP" \
          '{
            content: null,
            embeds: [
              {
                title: ("ğŸš€ New Push in `" + $repo + "`"),
                description: ("ğŸ‘¤ **User:** `" + $user + "`\nğŸ“ **Message:**\n> " + $msg + "\nğŸ”— [View Commit](" + $url + ")"),
                color: 15844367,
                fields: [
                  {name: "ğŸŸ©âœ¨ Added Files", value: "```" + $added + "```"},
                  {name: "ğŸŸ¨âš™ï¸ Modified Files", value: "```" + $modified + "```"},
                  {name: "ğŸŸ¥ğŸ—‘ï¸ Removed Files", value: "```" + $removed + "```"}
                ],
                footer: {text: "GitHub Webhook Logger by a silly cat :3"},
                timestamp: $timestamp
              }
            ]
          }')

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$PAYLOAD" \
               "$DISCORD_WEBHOOK_URL"
