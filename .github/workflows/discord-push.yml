name: Notify Discord with Style

on: [push]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send styled push info to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          REPO="${GITHUB_REPOSITORY}"
          USER="${GITHUB_ACTOR}"
          COMMIT_MSG="${GITHUB_EVENT_HEAD_COMMIT_MESSAGE}"
          URL="${GITHUB_EVENT_HEAD_COMMIT_URL}"

          # Extract push data using GitHub's event JSON
          EVENT_PATH="$GITHUB_EVENT_PATH"

          ADDED=$(jq -r '.head_commit.added | join("\n")' "$EVENT_PATH")
          MODIFIED=$(jq -r '.head_commit.modified | join("\n")' "$EVENT_PATH")
          REMOVED=$(jq -r '.head_commit.removed | join("\n")' "$EVENT_PATH")

          [ -z "$ADDED" ]    && ADDED="‚ùå None"
          [ -z "$MODIFIED" ] && MODIFIED="‚ùå None"
          [ -z "$REMOVED" ]  && REMOVED="‚ùå None"

          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          EMBED=$(jq -n \
            --arg repo "$REPO" \
            --arg user "$USER" \
            --arg msg "$COMMIT_MSG" \
            --arg url "$URL" \
            --arg added "$ADDED" \
            --arg modified "$MODIFIED" \
            --arg removed "$REMOVED" \
            --arg timestamp "$TIMESTAMP" \
            '{
              "content": null,
              "embeds": [
                {
                  "title": ("üöÄ New Push in " + $repo),
                  "url": $url,
                  "description": $msg,
                  "color": 5814783,
                  "author": {
                    "name": $user,
                    "url": ("https://github.com/" + $user),
                    "icon_url": ("https://github.com/" + $user + ".png?size=64")
                  },
                  "fields": [
                    { "name": "‚ûï Added",     "value": $added,     "inline": true },
                    { "name": "‚úèÔ∏è Modified", "value": $modified,  "inline": true },
                    { "name": "‚ûñ Removed",  "value": $removed,   "inline": true }
                  ],
                  "footer": {
                    "text": "GitHub Actions ‚Ä¢ " + $repo,
                    "icon_url": "https://github.githubassets.com/favicon.ico"
                  },
                  "timestamp": $timestamp
                }
              ]
            }')

          curl -s -H "Content-Type: application/json" \
               -d "${EMBED}" \
               "$DISCORD_WEBHOOK_URL"
