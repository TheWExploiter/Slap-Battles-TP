name: Notify Discord with Style

on: [push]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send push details to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          EVENT_PATH="$GITHUB_EVENT_PATH"
          REPO="$GITHUB_REPOSITORY"
          USER="$GITHUB_ACTOR"

          COMMIT_MSG=$(jq -r '.head_commit.message' "$EVENT_PATH")
          COMMIT_URL=$(jq -r '.head_commit.url' "$EVENT_PATH")
          ADDED=$(jq -r '.head_commit.added | join("\n")' "$EVENT_PATH")
          MODIFIED=$(jq -r '.head_commit.modified | join("\n")' "$EVENT_PATH")
          REMOVED=$(jq -r '.head_commit.removed | join("\n")' "$EVENT_PATH")

          [ -z "$ADDED" ] && ADDED="❌ None"
          [ -z "$MODIFIED" ] && MODIFIED="❌ None"
          [ -z "$REMOVED" ] && REMOVED="❌ None"

          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          jq -n \
            --arg repo "$REPO" \
            --arg user "$USER" \
            --arg msg "$COMMIT_MSG" \
            --arg url "$COMMIT_URL" \
            --arg added "$ADDED" \
            --arg modified "$MODIFIED" \
            --arg removed "$REMOVED" \
            --arg timestamp "$TIMESTAMP" \
            '{
              "embeds": [
                {
                  "title": ("🚀 Push to " + $repo),
                  "url": $url,
                  "description": $msg,
                  "color": 3447003,
                  "author": {
                    "name": $user,
                    "url": ("https://github.com/" + $user),
                    "icon_url": ("https://github.com/" + $user + ".png")
                  },
                  "fields": [
                    { "name": "➕ Added", "value": $added, "inline": true },
                    { "name": "✏️ Modified", "value": $modified, "inline": true },
                    { "name": "➖ Removed", "value": $removed, "inline": true }
                  ],
                  "footer": {
                    "text": "GitHub Actions",
                    "icon_url": "https://github.githubassets.com/favicons/favicon.png"
                  },
                  "timestamp": $timestamp
                }
              ]
            }' > payload.json

          curl -s -X POST -H "Content-Type: application/json" \
            -d @payload.json "$DISCORD_WEBHOOK_URL"
